<html>
  <head>
    <meta charset="big5">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <style>
input[type='checkbox'] {
  transform: scale(2);
  margin-right: 1em;
}
thead{
  font-weight:bold;
}
td{
  text-align:center;
  white-space:nowrap;
  padding-left:0px !important;
  padding-right:0px !important;
}
#search-bar{
  position:fixed;
  top:0px;
}
#loading{
  position:fixed;
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.5);
  color:white;
  font-size:100pt;
  font-weight:bold;
  text-align:center;
  overflow:hidden;
}
#content{
  margin-top:2em;
}
    </style>
  </head>
  <body>

    <div id="authorize-div" style="display: none">
      <div class="alert alert-success" role="alert">
        <strong>Authorize access to Google Sheets API</strong>
      </div>
      <button id="authorize-button" class="btn btn-success" onclick="handleAuthClick(event)">Authorize</button>
    </div>

    <div id="main" style="display: none">

      <div id="search-bar" class="input-group">
        <input type="text" class="form-control" placeholder="輸入搜尋的名字" v-model="query">
        <span class="input-group-addon">
          <input type="checkbox" v-model="showPaidValid">
          有效會員
        </span>
        <span class="input-group-addon">
          <input type="checkbox" v-model="showUnpaidValid">
          未繳費有效會員
        </span>
        <span class="input-group-addon">
          <input type="checkbox" v-model="showPaidInvalid">
          已繳費無效會員
        </span>
        <span class="input-group-addon">
          <input type="checkbox" v-model="showUnpaidInvalid">
          未繳費無效會員
        </span>
      </div>

      <div id="loading" style="display: none"></div>

      <div id="content" class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <td>No.</td>
              <td>外號</td>
              <td>姓名</td>
              <td>會費</td>
              <td v-for="d in dates"><span class="tag tag-default">{{simpleDate(d)}}</span></td>
              <td>Sum</td>
              <td>isValid</td>
            </tr>
          </thead>
          <tr :bgcolor="rowColor(row)" v-for="row in queried_rows(query)">
            <td>{{row.no}}</td>
            <td>{{row.nickname}}</td>
            <td>{{row.name}}</td>
            <td>{{hasFeePaidText(row.hasFeePaid)}}</td>
            <td v-if="row.attendance.length>0" v-for="(i,d) in dates">{{row.attendance[i]}}</td>
            <td id="member{{row.no}}" v-if="dates.length>0&&row.attendance.length==0" :colspan="dates.length"></td>
            <td>{{row.attendSum}}</td>
            <td>{{isValidText(row.isValid)}}</td>
          </tr>
        </table>
      </div>

    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <!-- promise -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.4.6/bluebird.min.js"></script>
    <!-- Google sheet -->
    <script src="google-sheet.js"></script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
    <!-- Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.26/vue.min.js"></script>
    <script>
var vm = new Vue({
  el:"#main",
  data:{
    rows:[],
    dates:[],
    query:"",
    showPaidValid: true,
    showUnpaidValid: true,
    showPaidInvalid: true,
    showUnpaidInvalid: true,
  },
  methods:{
    queried_rows:function(query){
      query = query.trim();

      var showPaidValid = this.showPaidValid;
      var showUnpaidValid = this.showUnpaidValid;
      var showPaidInvalid = this.showPaidInvalid;
      var showUnpaidInvalid = this.showUnpaidInvalid;
      return this.rows.filter(function(row){
        var match_nickname = row.nickname&&row.nickname.toLowerCase().indexOf(query.toLowerCase())!=-1;
        var match_name = row.name&&row.name.toLowerCase().indexOf(query.toLowerCase())!=-1;

        var match_paid_valid = row.hasFeePaid===true && row.isValid===true;
        var match_paid_invalid = row.hasFeePaid===true && row.isValid!==true;
        var match_unpaid_valid = row.hasFeePaid!==true && row.isValid===true;
        var match_unpaid_invalid = row.hasFeePaid!==true && row.isValid!==true;
        var match_type = showPaidValid && match_paid_valid ||
            showPaidInvalid && match_paid_invalid ||
            showUnpaidValid && match_unpaid_valid ||
            showUnpaidInvalid && match_unpaid_invalid;

        var hasQuery = query!="";
        var notUnique = row.unique===false;
        return notUnique || hasQuery&&(match_nickname||match_name) || !hasQuery&&match_type;
      });
    },
    isValidText:function(isValid){
      return isValid?"有效會員":"無效會員";
    },
    simpleDate: function(d){
      var M = d.getMonth()+1;
      var D = d.getDate();
      return (M<10?"0"+M:M)+(D<10?"0"+D:D);
    },
    hasFeePaidText: function(b){
      return b? '已繳': '未繳';
    },
    rowColor: function(row){
    if(row.isValid && row.hasFeePaid) return '#8cc8f8';
    if(row.isValid && !row.hasFeePaid) return '#8cc8a8';
    if(!row.isValid && row.hasFeePaid) return '#8cc8c8';
    if(!row.isValid && !row.hasFeePaid) return '#ffffff';//rgb(255,255,255)';
    },
  },
});

function addConflictButton(i){
  $('#member'+(i+1)).html(
      $('<button>').addClass('btn btn-danger').text('有資料衝突，點選我解決...').click(solveConflict(i))
  );
}

var loading = {
  timer:null,
  text:"LOADING",
  indicator:"⣾⣽⣻⢿⡿⣟⣯⣷",
  i:0,
  dt:100,
  run:function(isRun){
    var tgt = $("#loading");
    tgt.text(loading.text);
    if(isRun){
      tgt.fadeIn('slow');
      timer = setInterval(function(){
        var indicator = loading.indicator.charAt(loading.i);
        tgt.text(indicator + loading.text + indicator);
        loading.i = (loading.i+1)%loading.indicator.length;
      }, loading.dt);
    }
    else{
      tgt.fadeOut();
      timer = clearInterval(loading.timer);
    }
  }
};

    </script>

  </body>
</html>

