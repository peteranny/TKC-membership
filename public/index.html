<html>
  <head>
    <meta charset="big5">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <style>
thead{
  font-weight:bold;
}
td{
  text-align:center;
  white-space:nowrap;
  padding-left:0px !important;
  padding-right:0px !important;
}
#search-bar{
  position:fixed;
  top:0px;
}
#loading{
  position:fixed;
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.5);
  color:white;
  font-size:100pt;
  font-weight:bold;
  text-align:center;
  overflow:hidden;
}
#content{
  margin-top:2em;
}
#clipboard{
  width:100%;
  height:20em;
}
.paid_valid{
  background-color:rgb(255,200,200);
}
.paid_invalid{
  background-color:rgb(200,200,200);
}
.unpaid_valid{
  background-color:rgb(150,200,200);
}
.unpaid_invalid{
  background-color:rgb(255,255,255);
}
    </style>
  </head>
  <body>

    <div id="authorize-div" style="display: none">
      <div class="alert alert-success" role="alert">
        <strong>Authorize access to Google Sheets API</strong>
      </div>
      <button id="authorize-button" class="btn btn-success" onclick="handleAuthClick(event)">Authorize</button>
    </div>

    <div id="main" style="display: none">

      <div id="search-bar" class="input-group">
        <input type="text" class="form-control" placeholder="輸入搜尋的名字" v-model="query">
        <span class="input-group-btn">
          <button class="btn btn-secondary" @click="copyList()">
            複製以下名單！
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showPaidValid}]" @click="showPaidValid=!showPaidValid">
            顯示有效會員
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showUnpaidValid}]" @click="showUnpaidValid=!showUnpaidValid">
            顯示有未繳費有效會員
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showPaidInvalid}]" @click="showPaidInvalid=!showPaidInvalid">
            顯示有已繳費無效會員
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showUnpaidInvalid}]" @click="showUnpaidInvalid=!showUnpaidInvalid">
            顯示有未繳費無效會員
          </button>
        </span>
      </div>

      <div id="loading" style="display: none"></div>

      <div id="content" class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <td>No.</td>
              <td>姓名</td>
              <td>外號</td>
              <td>會費</td>
              <td v-for="d in dates"><span class="tag tag-default">{{simpleDate(d)}}</span></td>
              <td>Sum</td>
              <td>isValid</td>
            </tr>
          </thead>
          <tr :class="memberType(row)" v-for="row in queried_rows">
            <td>{{row.no}}</td>
            <td>{{row.name}}</td>
            <td>{{row.nickname}}</td>
            <td>{{hasFeePaidText(row.hasFeePaid)}}</td>
            <td v-if="row.attendance.length>0" v-for="(i,d) in dates">{{row.attendance[i]}}</td>
            <td id="member{{row.no}}" v-if="dates.length>0&&row.attendance.length==0" :colspan="dates.length"></td>
            <td>{{row.attendSum}}</td>
            <td>{{isValidText(row.isValid)}}</td>
          </tr>
        </table>
      </div>

    </div>

		<div class="modal fade">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-body">
						<textarea id="clipboard"></textarea>
					</div>
				</div>
			</div>
		</div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <!-- promise -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.4.6/bluebird.min.js"></script>
    <!-- Google sheet -->
    <script src="google-sheet.js"></script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
    <!-- Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.26/vue.min.js"></script>
    <script>
var vm = new Vue({
  el:"#main",
  data:{
    rows:[],
    dates:[],
    query:"",
    showPaidValid: true,
    showUnpaidValid: true,
    showPaidInvalid: true,
    showUnpaidInvalid: true,
  },
	computed:{
		queried_rows:function(){
			query = this.query.trim();

			var showPaidValid = this.showPaidValid;
			var showUnpaidValid = this.showUnpaidValid;
			var showPaidInvalid = this.showPaidInvalid;
			var showUnpaidInvalid = this.showUnpaidInvalid;
			var memberType = this.memberType;
			return this.rows.filter(function(row){
				var match_nickname = row.nickname&&row.nickname.toLowerCase().indexOf(query.toLowerCase())!=-1;
				var match_name = row.name&&row.name.toLowerCase().indexOf(query.toLowerCase())!=-1;
				var match_type =
					showPaidValid && memberType(row)=='paid_valid' ||
					showPaidInvalid && memberType(row)=='paid_invalid' ||
					showUnpaidValid && memberType(row)=='unpaid_valid' ||
					showUnpaidInvalid && memberType(row)=='unpaid_invalid';
				var hasQuery = query!="";
				var notUnique = row.unique===false;
				return notUnique || hasQuery&&(match_nickname||match_name) || !hasQuery&&match_type;
			});
		},
	},
  methods:{
    simpleDate: function(d){
      var M = d.getMonth()+1;
      var D = d.getDate();
      return (M<10?"0"+M:M)+(D<10?"0"+D:D);
    },
    isValidText:function(isValid){
      return isValid==undefined?'':isValid?"有效會員":"無效會員";
    },
    hasFeePaidText: function(hasFeePaid){
      return hasFeePaid==undefined?'':hasFeePaid? '已繳': '未繳';
    },
    memberType: function(row){
      if(row.isValid==true && row.hasFeePaid==true) return 'paid_valid';
      if(row.isValid==true && row.hasFeePaid!=true) return 'unpaid_valid';
      if(row.isValid!=true && row.hasFeePaid==true) return 'paid_invalid';
      if(row.isValid!=true && row.hasFeePaid!=true) return 'unpaid_invalid';
    },
    copyList: function(){
      $('#clipboard').text(this.queried_rows.map(function(row){
        return row.name+"("+row.nickname+")";
      }).join('\n'));
      $('.modal').modal('show')
    }
  },
});

function addConflictButton(i){
  $('#member'+(i+1)).html(
      $('<button>').addClass('btn btn-danger').text('有資料衝突，點選我解決...').click(solveConflict(i))
  );
}

var loading = {
  timer:null,
  text:"LOADING",
  indicator:"⣾⣽⣻⢿⡿⣟⣯⣷",
  i:0,
  dt:100,
  run:function(isRun){
    var tgt = $("#loading");
    tgt.text(loading.text);
    if(isRun){
      tgt.fadeIn('slow');
      timer = setInterval(function(){
        var indicator = loading.indicator.charAt(loading.i);
        tgt.text(indicator + loading.text + indicator);
        loading.i = (loading.i+1)%loading.indicator.length;
      }, loading.dt);
    }
    else{
      tgt.fadeOut();
      timer = clearInterval(loading.timer);
    }
  }
};

    </script>

  </body>
</html>

