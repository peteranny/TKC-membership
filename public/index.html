<html>
  <head>
    <meta charset="big5">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/4.4.0/font/octicons.min.css" />
    <style>
body:after{
  content: "";
  display: block;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0.5;
  z-index: -1;
  background-image: url('images/logo.png');
  background-repeat: no-repeat;
  background-position: right bottom;
  background-attachment: fixed;
}
thead{
  font-weight:bold;
}
td{
  text-align:center;
  white-space:nowrap;
  padding-left:0px !important;
  padding-right:0px !important;
}
#search-bar{
  position:fixed;
  top:0px;
}
#loading{
  position:fixed;
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.5);
  color:white;
  font-size:100pt;
  font-weight:bold;
  text-align:center;
  overflow:hidden;
}
#content{
  margin-top:2em;
}
#clipboard{
  width:100%;
  height:20em;
}
.paid_valid{
  background-color:rgba(150,200,200,0.5);
}
.paid_invalid{
  background-color:rgba(200,200,200,0.5);
}
.unpaid_valid{
  background-color:rgba(255,200,200,0.5);
}
.unpaid_invalid{
  background-color:rgba(255,255,255,0.5);
}
    </style>
  </head>
  <body>

    <div id="authorize-div" style="display: none">
      <div class="alert alert-success" role="alert">
        <strong>Authorize access to Google Sheets API</strong>
      </div>
      <button id="authorize-button" class="btn btn-success" onclick="handleAuthClick(event)">Authorize</button>
    </div>

    <div id="main" style="display: none">

      <div id="search-bar" class="input-group">
        <input type="text" class="form-control" style="padding:right:15px;" placeholder="搜尋名字或外號" v-model="query">
        <span class="input-group-btn">
          <button class="btn btn-secondary" href="#" onclick="vm.query=''">
            <span class="octicon octicon-arrow-left"></span>清除
          </button>
        </span>
        <span class="input-group-btn">
          <button class="btn btn-success" @click="copyList()">
            複製以下名單！
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showPaidValid}]" @click="showPaidValid=!showPaidValid">
            <span :class="['octicon', showPaidValid?'octicon-check':'octicon-x']"></span>繳費有效會員
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showUnpaidValid}]" @click="showUnpaidValid=!showUnpaidValid">
            <span :class="['octicon', showUnpaidValid?'octicon-check':'octicon-x']"></span>未繳費有效會員
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showPaidInvalid}]" @click="showPaidInvalid=!showPaidInvalid">
            <span :class="['octicon', showPaidInvalid?'octicon-check':'octicon-x']"></span>已繳費無效會員
          </button>
        </span>
        <span class="input-group-btn">
          <button :class="['btn', 'btn-secondary', {'active':showUnpaidInvalid}]" @click="showUnpaidInvalid=!showUnpaidInvalid">
            <span :class="['octicon', showUnpaidInvalid?'octicon-check':'octicon-x']"></span>未繳費無效會員
          </button>
        </span>
      </div>

      <div id="loading" style="display: none"></div>

      <div id="content" class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <td>No.</td>
              <td>姓名</td>
              <td>外號</td>
              <td>會費</td>
              <td v-for="d in dates"><span class="tag tag-default">{{simpleDate(d)}}</span></td>
              <td>Sum</td>
              <td>isValid</td>
            </tr>
          </thead>
          <tr :class="memberType(row)" v-for="row in queried_rows">
            <td>{{row.no}}</td>
            <td>{{row.name}}</td>
            <td>{{row.nickname}}</td>
            <td>{{hasFeePaidText(row.hasFeePaid)}}</td>
            <td v-if="row.attendance.length>0" v-for="(i,d) in dates">
              {{row.attendance[i]}}
            </td>
            <td v-if="dates.length>0&&row.attendance.length==0" :colspan="dates.length">
              <button class="btn btn-danger" v-if="row.unique===false" onclick="solveConflict({{row.no}})">
                有資料衝突，點選我解決...
              </button>
            </td>
            <td>{{row.attendSum}}</td>
            <td>{{isValidText(row.isValid)}}</td>
          </tr>
          <tr v-if="query!='' && queried_rows.length==0">
            <td :colspan="6 + dates.length"><em>查無名單符合「{{query}}」</em></td>
          </tr>
        </table>
      </div>

    </div>

    <div class="modal fade">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <textarea id="clipboard"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <!-- promise -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.4.6/bluebird.min.js"></script>
    <!-- Google sheet -->
    <script src="config.js"></script>
    <script src="google-sheet.js"></script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
    <!-- Vue.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.26/vue.min.js"></script>
    <script>
var vm = new Vue({
  el:"#main",
  data:{
    rows:[],
    dates:[],
    query:"",
    showPaidValid: true,
    showUnpaidValid: false,
    showPaidInvalid: false,
    showUnpaidInvalid: false,
  },
  computed:{
    queried_rows:function(){
      query = this.query.trim();

      var showPaidValid = this.showPaidValid;
      var showUnpaidValid = this.showUnpaidValid;
      var showPaidInvalid = this.showPaidInvalid;
      var showUnpaidInvalid = this.showUnpaidInvalid;
      var memberType = this.memberType;
      return this.rows.filter(function(row){
        var match_nickname = row.nickname&&row.nickname.toLowerCase().indexOf(query.toLowerCase())!=-1;
        var match_name = row.name&&row.name.toLowerCase().indexOf(query.toLowerCase())!=-1;
        var match_type =
          showPaidValid && memberType(row)=='paid_valid' ||
          showPaidInvalid && memberType(row)=='paid_invalid' ||
          showUnpaidValid && memberType(row)=='unpaid_valid' ||
          showUnpaidInvalid && memberType(row)=='unpaid_invalid';
        var hasQuery = query!="";
        var notUnique = row.unique===false;
        return notUnique || hasQuery&&(match_nickname||match_name) || !hasQuery&&match_type;
      });
    },
  },
  methods:{
    simpleDate: function(d){
      var M = d.getMonth()+1;
      var D = d.getDate();
      return (M<10?"0"+M:M)+(D<10?"0"+D:D);
    },
    isValidText:function(isValid){
      return isValid==undefined?'':isValid?"有效會員":"無效會員";
    },
    hasFeePaidText: function(hasFeePaid){
      return hasFeePaid==undefined?'':hasFeePaid? '已繳': '未繳';
    },
    memberType: function(row){
      if(row.isValid==true && row.hasFeePaid==true) return 'paid_valid';
      if(row.isValid==true && row.hasFeePaid!=true) return 'unpaid_valid';
      if(row.isValid!=true && row.hasFeePaid==true) return 'paid_invalid';
      if(row.isValid!=true && row.hasFeePaid!=true) return 'unpaid_invalid';
    },
    copyList: function(){
      $('#clipboard').text(this.queried_rows.map(function(row){
        return row.name+"("+row.nickname+")";
      }).join('\n'));
      $('.modal').modal('show')
    }
  },
});

var configURI = "config.html"
var loading = {
  timer:null,
  loadingText:"載入中",
  failText:"載入失敗",
  indicator:"⣾⣽⣻⢿⡿⣟⣯⣷",
  i:0,
  dt:100,
  run:function(isRun){
    $('#loading').text(loading.loadingText);
    $('#loading').fadeIn('slow');
    loading.timer = setInterval(function(){
      var indicator = loading.indicator.charAt(loading.i);
      $('#loading').text(indicator + loading.loadingText + indicator);
      loading.i = (loading.i+1)%loading.indicator.length;
    }, loading.dt);
  },
  close: function(){
    $('#loading').text(loading.loadingText);
    $('#loading').fadeOut();
    clearInterval(loading.timer);
  },
  fail:function(err){
    clearInterval(loading.timer);
    $('#loading').text(loading.failText).append(
      $('<h6>').append($('<blockquote>').text(err))
    ).append(
      $('<a>').addClass('btn btn-danger btn-lg').text('進入管理介面').attr('href',configURI)
    );
  },
};

    </script>

  </body>
</html>

